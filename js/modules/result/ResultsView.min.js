var ResultsView,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments);};},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];
}}function c(){this.constructor=d;}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d;};ResultsView=(function(b){__extends(a,b);
function a(){this.afterRender=__bind(this.afterRender,this);this.updateOptions=__bind(this.updateOptions,this);this.detectTablets=__bind(this.detectTablets,this);
_ref=a.__super__.constructor.apply(this,arguments);return _ref;}a.prototype.events={"click .cloud":"cloud","click .csv":"csv","click .tablets":"tablets","click .detect":"detectOptions"};
a.prototype.cloud=function(){var c=this;if(this.available.cloud.ok){$.couch.replicate(Tangerine.config.address.local.dbName,Tangerine.config.address.cloud.host+"/"+Tangerine.config.address.cloud.dbName,{success:function(){return c.$el.find(".status").find(".info_box").html("Results synced to cloud successfully");
},error:function(e,d){return c.$el.find(".status").find(".info_box").html("<div>Sync error</div><div>"+e+" "+d+"</div>");}},{doc_ids:this.docList});}else{Utils.midAlert("Cannot detect cloud");
}return false;};a.prototype.tablets=function(){var f,h,e,d,c,g=this;if(this.available.tablets.okCount>0){c=this.available.tablets.ips;h=function(i){return $.couch.replicate(Tangerine.config.address.local.dbName,("http://"+i+":5984/")+Tangerine.config.address.local.dbName,{success:function(){return g.$el.find(".status").find(".info_box").html("Results synced to "+g.available.tablets.okCount+" successfully");
},error:function(k,j){return g.$el.find(".status").find(".info_box").html("<div>Sync error</div><div>"+k+" "+j+"</div>");}},{doc_ids:g.docList});};for(e=0,d=c.length;
e<d;e++){f=c[e];h(f);}}else{Utils.midAlert("Cannot detect tablets");}return false;};a.prototype.csv=function(){var c;c=new CSVView({assessmentId:this.assessment.id});
return c.render();};a.prototype.initDetectOptions=function(){return this.available={cloud:{ok:false,checked:false},tablets:{ips:[],okCount:0,checked:0,total:256}};
};a.prototype.detectOptions=function(){this.detectCloud();return this.detectTablets();};a.prototype.detectCloud=function(){var c=this;return $.ajax({dataType:"jsonp",url:Tangerine.config.address.cloud.host+":"+Tangerine.config.address.port+"/",success:function(e,d){return c.available.cloud.ok=true;
},error:function(e,d){return c.available.cloud.ok=false;},complete:function(){c.available.cloud.checked=true;return c.updateOptions();}});};a.prototype.detectTablets=function(){var e,d,f,c,g=this;
d=Tangerine.config.address.port;c=[];for(e=f=0;f<=255;e=++f){c.push((function(i,h){var j;j="192.168.1."+i;return $.ajax({dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:30000,url:"http://"+j+":"+h+"/",complete:function(l,k){g.available.tablets.checked++;
if(l.status===200){g.available.tablets.okCount++;g.available.tablets.ips.push(j);}return g.updateOptions();}});})(e,d));}return c;};a.prototype.updateOptions=function(){var e,d,c;
d=Math.decimals((this.available.tablets.checked/this.available.tablets.total)*100,2);if(d===100){e="finished";}else{e=""+d+"%";}c="Searching for tablets: "+e;
if(this.available.tablets.checked>0){this.$el.find(".checking_status").html(""+c);}if(this.available.cloud.checked&&this.available.tablets.checked===this.available.tablets.total){this.$el.find(".status .info_box").html("Done detecting options");
this.$el.find(".checking_status").hide();}if(this.available.cloud.ok){this.$el.find("button.cloud").removeAttr("disabled");}if(this.available.tablets.okCount>0&&d===100){return this.$el.find("button.tablets").removeAttr("disabled");
}};a.prototype.initialize=function(f){var d,g,e,c;this.subViews=[];this.results=f.results;this.model=f.model;this.assessment=f.assessment;this.docList=[];
c=this.results;for(g=0,e=c.length;g<e;g++){d=c[g];this.docList.push(d.id);}this.initDetectOptions();return this.detectCloud();};a.prototype.render=function(){var f,i,g,l,h,j,e,k,d,c;
this.clearSubViews();f="<button class='cloud command' disabled='disabled'>Cloud</button>";h="<button class='tablets command' disabled='disabled'>Tablets</button>";
i="<button class='csv command'>CSV</button>";g="      <h1>"+(this.assessment.get("name"))+"</h1>      <h2>Save options</h2>      <div class='menu_box'>        "+(Tangerine.settings.context==="mobile"?f:"")+"        "+(Tangerine.settings.context==="mobile"?h:"")+"        "+i+"      </div>";
if(Tangerine.settings.context==="mobile"){g+="        <button class='detect command'>Detect options</button>        <div class='status'>          <h2>Status</h2>          <div class='info_box'></div>          <div class='checking_status'></div>        </div>        ";
}g+="      <h2>Results</h2>    ";this.$el.html(g);if(((d=this.results)!=null?d.length:void 0)===0){this.$el.append("No results yet!");}else{c=this.results;
for(e=0,k=c.length;e<k;e++){l=c[e];j=new ResultSumView({model:l,finishCheck:true});j.render();this.subViews.push(j);this.$el.append(j.el);}}return this.trigger("rendered");
};a.prototype.afterRender=function(){var f,g,e,c,d;c=this.subViews;d=[];for(g=0,e=c.length;g<e;g++){f=c[g];d.push(typeof f.afterRender==="function"?f.afterRender():void 0);
}return d;};a.prototype.clearSubViews=function(){var e,f,d,c;c=this.subViews;for(f=0,d=c.length;f<d;f++){e=c[f];e.close();}return this.subViews=[];};return a;
})(Backbone.View);