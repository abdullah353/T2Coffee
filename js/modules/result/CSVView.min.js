var CSVView,_ref,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];}}function c(){this.constructor=d;
}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d;};CSVView=(function(b){__extends(a,b);function a(){_ref=a.__super__.constructor.apply(this,arguments);
return _ref;}a.prototype.exportValueMap={correct:1,checked:1,incorrect:0,unchecked:0,missing:".",not_asked:"."};a.prototype.initialize=function(d){var c,e=this;
this.assessmentId=Utils.cleanURL(d.assessmentId);c=new Results;c.fetch({key:this.assessmentId,success:function(f){e.results=f.models;return e.render();
}});return this.metaKeys=["enumerator"];};a.prototype.exportValue=function(c){if(this.exportValueMap[c]!=null){return this.exportValueMap[c];}else{return c;
}};a.prototype.render=function(){var N,u,P,ap,O,M,an,y,D,A,z,X,x,am,H,aj,Y,E,G,ac,J,ao,ak,al,W,v,h,C,F,K,k,j,g,f,w,ai,L,ah,ag,af,ae,ad,ab,aa,Z,e,c,ay,ax,aw,av,t,V,U,T,S,R,Q,s,r,q,p,o,n,m,l,I,au,at,ar,aq,B=this;
if((this.results!=null)&&(this.results[0]!=null)){F="";ap=[];N=[];A=[];t=this.results;for(k=0,w=t.length;k<w;k++){ao=t[k];G=ao.has("order_map")?ao.get("order_map"):(function(){I=[];
for(var d=0,i=ao.attributes.subtestData.length-1;0<=i?d<=i:d>=i;0<=i?d++:d--){I.push(d);}return I;}).apply(this);for(J=g=0,r=ao.attributes.subtestData.length-1;
0<=r?g<=r:g>=r;J=0<=r?++g:--g){W=G.indexOf(J);al=ao.attributes.subtestData[W];v=al.name.toLowerCase().dasherize();ac=al.prototype;D=[];if(ac==="id"){D.push("id");
}else{if(ac==="datetime"){D.push("year","month","date","assess_time");}else{if(ac==="location"){q=al.data.labels;for(f=0,ai=q.length;f<ai;f++){z=q[f];D.push(z);
}}else{if(ac==="consent"){D.push("consent");}else{if(ac==="grid"){K=al.data.variable_name;D.push(""+K+"_auto_stop",""+K+"_time_remain",""+K+"_attempted",""+K+"_item_at_time",""+K+"_time_intermediate_captured",""+K+"_correct_per_minute");
p=al.data.items;for(M=e=0,ah=p.length;e<ah;M=++e){y=p[M];D.push(""+K+(M+1));}}else{if(ac==="survey"){o=al.data;for(C in o){h=o[C];if(_.isObject(h)){for(Y in h){E=h[Y];
D.push(""+C+"_"+Y);}}else{D.push(C);}}}else{if(ac==="observation"){n=al.data.surveys;for(M=c=0,ag=n.length;c<ag;M=++c){aj=n[M];H=aj.data;for(C in H){h=H[C];
if(_.isObject(h)){for(Y in h){E=h[Y];D.push(""+C+"_"+Y+"_"+(M+1));}}else{D.push(""+C+"_"+(M+1));}}}}else{if(ac==="complete"){D.push("additional_comments","end_time","gps_latitude","gps_longitude","gps_accuracy");
}}}}}}}}if(A[J]==null){A[J]=[];}if(A[J].length<D.length){A[J]=D;}}}this.metaKeys.push("start_time","order_map");N=this.metaKeys.concat(_.flatten(A));ap.push(N);
m=this.results;for(O=ay=0,af=m.length;ay<af;O=++ay){ao=m[O];ak=[];l=this.metaKeys;for(ax=0,ae=l.length;ax<ae;ax++){X=l[ax];if(ao.attributes[X]!=null){ak.push(ao.attributes[X]);
}}ak[N.indexOf("start_time")]=ao.has("starttime")?ao.get("starttime"):ao.get("start_time");ak[N.indexOf("order_map")]=ao.has("order_map")?ao.get("order_map"):"no_record";
V=ao.attributes.subtestData;for(aw=0,ad=V.length;aw<ad;aw++){al=V[aw];ac=al.prototype;if(ac==="id"){ak[N.indexOf("id")]=al.data.participant_id;}else{if(ac==="location"){U=al.data.labels;
for(M=av=0,ab=U.length;av<ab;M=++av){z=U[M];ak[N.indexOf(z)]=al.data.location[M];}}else{if(ac==="datetime"){am=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
if(~am.indexOf(al.data.month.toLowerCase())){x=am.indexOf(al.data.month.toLowerCase())+1;}else{x=al.data.month;}ak[N.indexOf("year")]=al.data.year;ak[N.indexOf("month")]=x;
ak[N.indexOf("date")]=al.data.day;ak[N.indexOf("assess_time")]=al.data.time;}else{if(ac==="consent"){ak[N.indexOf("consent")]=al.data.consent;}else{if(ac==="grid"){K=al.data.variable_name;
ak[N.indexOf(""+K+"_auto_stop")]=al.data.auto_stop;ak[N.indexOf(""+K+"_time_remain")]=al.data.time_remain;ak[N.indexOf(""+K+"_attempted")]=al.data.attempted;
ak[N.indexOf(""+K+"_item_at_time")]=al.data.item_at_time;ak[N.indexOf(""+K+"_time_intermediate_captured")]=al.data.time_intermediate_captured;ak[N.indexOf(""+K+"_correct_per_minute")]=al.sum.correct_per_minute;
T=al.data.items;for(M=au=0,aa=T.length;au<aa;M=++au){y=T[M];ak[N.indexOf(""+K+(M+1))]=this.exportValue(y.itemResult);}}else{if(ac==="survey"){S=al.data;
for(C in S){h=S[C];if(_.isObject(h)){for(Y in h){E=h[Y];ak[N.indexOf(""+C+"_"+Y)]=this.exportValue(E);}}else{ak[N.indexOf(""+C)]=this.exportValue(h);}}}else{if(ac==="observation"){R=al.data.surveys;
for(M=at=0,Z=R.length;at<Z;M=++at){aj=R[M];H=aj.data;for(C in H){h=H[C];if(_.isObject(h)){for(Y in h){E=h[Y];ak[N.indexOf(""+C+"_"+Y+"_"+(M+1))]=this.exportValue(E);
}}else{ak[N.indexOf(""+C+"_"+(M+1))]=this.exportValue(h);}}}}else{if(ac==="complete"){ak[N.indexOf("additional_comments")]=al.data.comment;ak[N.indexOf("end_time")]=al.data.end_time;
if(al.data.gps!=null){ak[N.indexOf("gps_latitude")]=al.data.gps.latitude;ak[N.indexOf("gps_longitude")]=al.data.gps.longitude;ak[N.indexOf("gps_accuracy")]=al.data.gps.accuracy;
}}}}}}}}}}ap.push(ak);}for(M=ar=0,L=ap.length;ar<L;M=++ar){ak=ap[M];F+="<tr>";u=0;for(an=aq=0,Q=ak.length-1;0<=Q?aq<=Q:aq>=Q;an=0<=Q?++aq:--aq){F+="<td>"+ak[an]+"</td>";
u++;}F+="</tr>";}F=F.replace(/undefined/g,"no_record");this.csv=$("<table>"+F+"</table>").table2CSV({delivery:"value"});P=new Backbone.Model({_id:"Tangerine-"+(this.assessmentId.substr(-5,5))+".csv"});
P.url="csv";P.fetch({complete:function(){return P.save({csv:B.csv},{complete:function(){return window.open("/tangerine/_design/tangerine/_show/csv/Tangerine-"+(B.assessmentId.substr(-5,5))+".csv","_blank");
}});}});}return this.trigger("rendered");};return a;})(Backbone.View);