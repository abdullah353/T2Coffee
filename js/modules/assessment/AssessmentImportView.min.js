var AssessmentImportView,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments);};},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];
}}function c(){this.constructor=d;}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d;};AssessmentImportView=(function(b){__extends(a,b);
function a(){this.updateProgress=__bind(this.updateProgress,this);this.updateActivity=__bind(this.updateActivity,this);this.updateFromActiveTasks=__bind(this.updateFromActiveTasks,this);
this["import"]=__bind(this["import"],this);_ref=a.__super__.constructor.apply(this,arguments);return _ref;}a.prototype.events={"click .import":"import","click .back":"back"};
a.prototype.initialize=function(){var c=this;this.docsRemaining=0;this.serverStatus="checking...";return $.ajax({dataType:"jsonp",url:Tangerine.config.address.cloud.host+":"+Tangerine.config.address.port+"/",success:function(e,d){c.serverStatus="Ok";
return c.updateServerStatus();},error:function(e,d){c.serverStatus="Not available";return c.updateServerStatus();}});};a.prototype.updateServerStatus=function(){return this.$el.find("#server_connection").html(this.serverStatus);
};a.prototype.back=function(){Tangerine.router.navigate("",true);return false;};a.prototype["import"]=function(){var c;this.updateActivity();c=this.$el.find("#d_key").val();
this.newAssessment=new Assessment;this.newAssessment.on("status",this.updateActivity);this.newAssessment.updateFromServer(c);return this.activeTaskInterval=setInterval(this.updateFromActiveTasks,3000);
};a.prototype.updateFromActiveTasks=function(){var c=this;return $.couch.activeTasks({success:function(h){var f,g,e,d;d=[];for(g=0,e=h.length;g<e;g++){f=h[g];
if(f.type.toLowerCase()==="replication"){if(!_.isEmpty(f.status)){c.activity=f.status;}d.push(c.updateProgress());}else{d.push(void 0);}}return d;}});};
a.prototype.updateActivity=function(c,d){this.$el.find(".status").fadeIn(250);this.activity="";if(c==="import lookup"){this.activity="Finding assessment";
}else{if(c==="import success"){clearInterval(this.activeTaskInterval);this.activity="Import successful";}else{if(c==="import error"){clearInterval(this.activeTaskInterval);
this.activity="Import error: "+d;}else{if(c==="import empty"){clearInterval(this.activeTaskInterval);this.activity="Nothing Found: Please Check your Key";
}}}}return this.updateProgress();};a.prototype.updateProgress=function(d){var f,e,c;if(d!=null){if(this.importList[d]!=null){this.importList[d]++;}else{this.importList[d]=1;
}}f="<table>";c=this.importList;for(d in c){e=c[d];f+="<tr><td>"+(d.titleize().pluralize())+"</td><td>"+e+"</td></tr>";}if(this.activity!=null){f+="<tr><td colspan='2'>"+this.activity+"</td></tr>";
}f+="</table>";return this.$el.find("#progress").html(f);};a.prototype.render=function(){this.$el.html("    <button class='back navigation'>Back</button>    <h1>Tangerine Central Import</h1>    <div class='question'>      <label for='d_key'>Download keys</label>      <input id='d_key' value=''>      <button class='import command'>Import</button><br>      <small>Server connection: <span id='server_connection'>"+this.serverStatus+"</span></small>    </div>    <div class='confirmation status'>      <h2>Status<h2>      <div class='info_box' id='progress'></div>    </div>    ");
return this.trigger("rendered");};return a;})(Backbone.View);