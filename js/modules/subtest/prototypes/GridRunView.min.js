var GridRunView,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments);};},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];
}}function c(){this.constructor=d;}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d;};GridRunView=(function(b){__extends(a,b);
function a(){this.updateMode=__bind(this.updateMode,this);this.updateCountdown=__bind(this.updateCountdown,this);this.removeUndo=__bind(this.removeUndo,this);
this.lastHandler=__bind(this.lastHandler,this);this.intermediateItemHandler=__bind(this.intermediateItemHandler,this);this.markHandler=__bind(this.markHandler,this);
this.gridClick=__bind(this.gridClick,this);_ref=a.__super__.constructor.apply(this,arguments);return _ref;}a.prototype.className="grid_prototype";a.prototype.events=Modernizr.touch?{"touchstart .grid_element":"gridClick","touchstart .end_of_grid_line":"endOfGridLineClick","click .grid_mode":"updateMode","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"}:{"click .end_of_grid_line":"endOfGridLineClick","click .grid_element":"gridClick","click .grid_mode":"updateMode","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"};
a.prototype.restartTimer=function(){this.resetVariables();return this.$el.find(".element_wrong").removeClass("element_wrong");};a.prototype.gridClick=function(e){var d,c;
return typeof(d=this.modeHandlers)[c=this.mode]==="function"?d[c](e):void 0;};a.prototype.markHandler=function(e){var c,d;c=$(e.target);d=c.attr("data-index");
if(this.lastAttempted!==0&&d>this.lastAttempted){return;}this.markElement(d);if(this.autostop!==0){return this.checkAutostop();}};a.prototype.intermediateItemHandler=function(e){var c,d;
this.timeIntermediateCaptured=this.getTime()-this.startTime;c=$(e.target);d=c.attr("data-index");this.itemAtTime=d;c.addClass("element_minute");return this.updateMode(null,"mark");
};a.prototype.checkAutostop=function(){var f,d,e,c;if(this.timeRunning){f=0;for(d=e=0,c=this.autostop-1;0<=c?e<=c:e>=c;d=0<=c?++e:--e){if(this.gridOutput[d]==="correct"){break;
}f++;}if(this.autostopped===false){if(f===this.autostop){this.autostopTest();}}if(this.autostopped===true&&f<this.autostop&&this.undoable===true){return this.unAutostopTest();
}}};a.prototype.markElement=function(d,e){var c;if(e==null){e=null;}if(this.lastAttempted!==0&&d>this.lastAttempted){return;}c=this.$el.find(".grid_element[data-index="+d+"]");
this.markRecord.push(d);if(e===null){this.gridOutput[d-1]=this.gridOutput[d-1]==="correct"||this.autostopped?"incorrect":"correct";return c.toggleClass("element_wrong");
}else{if(!this.autostopped||e==="correct"){this.gridOutput[d-1]=e;if(e==="incorrect"){return c.addClass("element_wrong");}else{if(e==="correct"){return c.removeClass("element_wrong");
}}}}};a.prototype.endOfGridLineClick=function(c){var d,j,k,l,h,f,g,e;if(this.mode==="mark"){d=$(c.target);if(d.hasClass("element_wrong")){d.removeClass("element_wrong");
l="correct";k=d.attr("data-index");for(j=h=k,g=k-(this.columns-1);k<=g?h<=g:h>=g;j=k<=g?++h:--h){this.markElement(j,l);}}else{if(!d.hasClass("element_wrong")&&!this.autostopped){d.addClass("element_wrong");
l="incorrect";k=d.attr("data-index");for(j=f=k,e=k-(this.columns-1);k<=e?f<=e:f>=e;j=k<=e?++f:--f){this.markElement(j,l);}}}if(this.autostop!==0){return this.checkAutostop();
}}};a.prototype.lastHandler=function(e){var c,d;c=$(e.target);d=c.attr("data-index");if(d-1>=this.gridOutput.lastIndexOf("incorrect")){this.$el.find("table.grid .element_last").removeClass("element_last");
c.addClass("element_last");return this.lastAttempted=d;}};a.prototype.startTimer=function(){if(this.timerStopped===false&&this.timeRunning===false){this.interval=setInterval(this.updateCountdown,1000);
this.startTime=this.getTime();this.timeRunning=true;this.updateMode(null,"mark");this.enableGrid();return this.updateCountdown();}};a.prototype.enableGrid=function(){return this.$el.find("table.disabled, div.disabled").removeClass("disabled");
};a.prototype.stopTimer=function(d,c){if(c==null){c=false;}if(this.timeRunning===true){Utils.flash();clearInterval(this.interval);this.stopTime=this.getTime();
this.timeRunning=false;this.timerStopped=true;this.updateCountdown();if(this.captureLastAttempted){this.updateMode(null,"last");}if(c){return Utils.topAlert(c);
}else{if(this.captureLastAttempted){return Utils.midAlert("Please mark <br>last item attempted");}}}};a.prototype.autostopTest=function(){Utils.flash();
clearInterval(this.interval);this.stopTime=this.getTime();this.autostopped=true;this.timerStopped=true;this.timeRunning=false;this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).addClass("element_last");
this.lastAttempted=this.autostop;this.timeout=setTimeout(this.removeUndo,3000);return Utils.topAlert("Autostop activated. Discontinue test.");};a.prototype.removeUndo=function(){this.undoable=false;
this.updateMode(null,"disabled");return clearTimeout(this.timeout);};a.prototype.unAutostopTest=function(){this.interval=setInterval(this.updateCountdown,1000);
this.updateCountdown();this.autostopped=false;this.lastAttempted=0;this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).removeClass("element_last");
this.timeRunning=true;this.updateMode(null,"mark");return Utils.topAlert("Autostop removed. Continue.");};a.prototype.updateCountdown=function(){this.timeElapsed=Math.min(this.getTime()-this.startTime,this.timer);
this.timeRemaining=this.timer-this.timeElapsed;this.$el.find(".timer").html(this.timeRemaining);if(this.timeRemaining<=0&&this.timeRunning===true&&this.captureLastAttempted){this.stopTimer(null,"Time<br><br>Please mark<br>last item attempted");
}if(this.captureItemAtTime&&!this.gotIntermediate&&!this.minuteMessage&&this.timeElapsed>=this.captureAfterSeconds){Utils.flash("yellow");Utils.midAlert("Please select the item the child is currently attempting.");
this.minuteMessage=true;return this.mode="minuteItem";}};a.prototype.updateMode=function(c,d){if(d==null){d=null;}if((d===null&&this.timeElapsed===0)||d==="disabled"){this.$el.find("#grid_mode :radio").removeAttr("checked");
this.$el.find("#grid_mode").buttonset("refresh");return;}if(d!=null){this.mode=d;this.$el.find("#grid_mode :radio[value="+d+"]").attr("checked","checked");
this.$el.find("#grid_mode").buttonset("refresh").click(this.updateMode);return;}if(!this.autostopped){return this.mode=$(c.target).val();}};a.prototype.getTime=function(){return Math.round((new Date()).getTime()/1000);
};a.prototype.resetVariables=function(){var n,o,p,q,j,h,f,d,s,v,u,t,r,c,m,l,k,g,e;this.gotMinuteItem=false;this.minuteMessage=false;this.itemAtTime=null;
this.timeIntermediateCaptured=null;this.markRecord=[];this.timerStopped=false;this.startTime=0;this.stopTime=0;this.timeElapsed=0;this.timeRemaining=this.timer;
this.lastAttempted=0;this.interval=null;this.undoable=true;this.timeRunning=false;this.timer=parseInt(this.model.get("timer"))||0;this.untimed=this.timer===0;
this.items=_.compact(this.model.get("items"));this.itemMap=[];this.mapItem=[];if(this.model.has("randomize")&&this.model.get("randomize")){m=this.items;
for(n=j=0,s=m.length;j<s;n=++j){o=m[n];this.itemMap[n]=n;}l=this.items;for(n=h=0,v=l.length;h<v;n=++h){o=l[n];p=Math.floor(Math.random()*this.items.length);
q=this.itemMap[p];this.itemMap[p]=this.itemMap[n];this.itemMap[n]=q;}k=this.itemMap;for(n=f=0,u=k.length;f<u;n=++f){o=k[n];this.mapItem[this.itemMap[n]]=n;
}}else{g=this.items;for(n=d=0,t=g.length;d<t;n=++d){o=g[n];this.itemMap[n]=n;this.mapItem[n]=n;}}if(!this.captureLastAttempted&&!this.captureItemAtTime){this.mode="mark";
}else{this.mode="disabled";}this.gridOutput=[];e=this.items;for(n=c=0,r=e.length;c<r;n=++c){o=e[n];this.gridOutput[n]="correct";}this.columns=parseInt(this.model.get("columns"))||3;
this.autostop=this.untimed?0:parseInt(this.model.get("autostop"))||0;this.autostopped=false;this.$el.find(".grid_element").removeClass("element_wrong").removeClass("element_last").addClass("disabled");
this.$el.find("table").addClass("disabled");this.$el.find(".timer").html(this.timer);return this.updateMode(null,this.mode);};a.prototype.initialize=function(c){var d;
this.captureAfterSeconds=this.model.has("captureAfterSeconds")?this.model.get("captureAfterSeconds"):0;this.captureItemAtTime=this.model.has("captureItemAtTime")?this.model.get("captureItemAtTime"):false;
this.captureLastAttempted=this.model.has("captureLastAttempted")?this.model.get("captureLastAttempted"):true;this.endOfLine=this.model.has("endOfLine")?this.model.get("endOfLine"):true;
this.layoutMode=this.model.has("layoutMode")?this.model.get("layoutMode"):"fixed";this.fontSize=this.model.has("fontSize")?this.model.get("fontSize"):"normal";
if(this.fontSize==="small"){d="font_size_small";}else{d="";}this.totalTime=this.model.get("timer")||0;this.modeHandlers={mark:this.markHandler,last:this.lastHandler,minuteItem:this.intermediateItemHandler,disabled:$.noop};
this.model=this.options.model;this.parent=this.options.parent;this.resetVariables();this.gridElement=_.template("<td><div data-label='{{label}}' data-index='{{i}}' class='grid_element "+d+"'>{{label}}</div></td>");
this.variableGridElement=_.template("<span data-label='{{label}}' data-index='{{i}}' class='grid_element "+d+"'>{{label}}</span>");if(this.layoutMode==="fixed"){return this.endOfGridLine=_.template("<td><div data-index='{{i}}' class='end_of_grid_line'>*</div></td>");
}else{return this.endOfGridLine=_.template("");}};a.prototype.render=function(){var r,j,o,c,l,m,q,t,s,p,k,n,g,e,d,u,h,f;o=0;n="<div class='timer_wrapper'><button class='start_time time'>Start</button><div class='timer'>"+this.timer+"</div></div>";
j=this.untimed?"":"disabled";m=!this.untimed?n:"";l="";if(this.layoutMode==="fixed"){l+="<table class='grid "+j+"'>";c=true;while(true){if(o>this.items.length){break;
}l+="<tr>";for(q=e=1,h=this.columns;1<=h?e<=h:e>=h;q=1<=h?++e:--e){if(o<this.items.length){l+=this.gridElement({label:_.escape(this.items[this.itemMap[o]]),i:o+1});
}o++;}if(c){if(o<(this.items.length+1)&&this.endOfLine){l+="<td></td>";}c=false;}else{if(o<(this.items.length+1)&&this.endOfLine){l+=this.endOfGridLine({i:o});
}}l+="</tr>";}l+="</table>";}else{l+="<div class='grid "+j+"'>";f=this.items;for(q=d=0,u=f.length;d<u;q=++d){t=f[q];l+=this.variableGridElement({label:_.escape(this.items[this.itemMap[q]]),i:q+1});
}l+="</div>";}m+=l;g="<div class='timer_wrapper'><button class='stop_time time'>Stop</button><div class='timer'>"+this.timer+"</div></div>";k="    <div>      <button class='restart command'>Restart</button>      <br>    </div>";
p="";if(this.captureLastAttempted||this.captureItemAtTime){s="";if(this.captureItemAtTime){s="          <label for='minute_item'>Item at "+this.captureAfterSeconds+" seconds</label>          <input class='grid_mode' name='grid_mode' id='minute_item' type='radio' value='minuteItem'>        ";
}r="";if(this.captureLastAttempted){r="          <label for='last_attempted'>Last attempted</label>          <input class='grid_mode' name='grid_mode' id='last_attempted' type='radio' value='last'>        ";
}p="        <div id='grid_mode' class='question buttonset clearfix'>          <label>Input mode</label><br>          <label for='mark'>Mark</label>          <input class='grid_mode' name='grid_mode' id='mark' type='radio' value='mark'>          "+s+"          "+r+"        </div>      ";
}m+="      "+(!this.untimed?g:"")+"      "+(!this.untimed?k:"")+"      "+p+"    ";this.$el.html(m);return this.trigger("rendered");};a.prototype.isValid=function(){if(this.captureLastAttempted&&this.lastAttempted===0){return false;
}if(this.timeRunning===true){return false;}return true;};a.prototype.showErrors=function(){if(this.captureLastAttempted&&this.lastAttempted===0){Utils.midAlert("Please touch<br>last item read.");
this.updateMode(null,"last");}if(this.timeRuning===true){return Utils.midAlert("Time still running.");}};a.prototype.getResult=function(){var f,g,j,h,d,k,e,c;
f=[];h=[];if(!this.captureLastAttempted){this.lastAttempted=this.items.length;}c=this.items;for(g=k=0,e=c.length;k<e;g=++k){j=c[g];if(this.mapItem[g]<this.lastAttempted){h[g]={itemResult:this.gridOutput[this.mapItem[g]],itemLabel:j};
}else{h[g]={itemResult:"missing",itemLabel:this.items[this.mapItem[g]]};}}if(!this.captureLastAttempted){this.lastAttempted=false;}return d={capture_last_attempted:this.captureLastAttempted,item_at_time:this.itemAtTime,time_intermediate_captured:this.timeIntermediateCaptured,capture_item_at_time:this.captureItemAtTime,auto_stop:this.autostopped,attempted:this.lastAttempted,items:h,time_remain:this.timeRemaining,mark_record:this.markRecord,variable_name:this.model.get("variableName")};
};a.prototype.getSkipped=function(){var f,h,g,d,j,e,c;g=[];c=this.items;for(f=j=0,e=c.length;j<e;f=++j){h=c[f];g[f]={itemResult:"skipped",itemLabel:h};
}return d={capture_last_attempted:"skipped",item_at_time:"skipped",time_intermediate_captured:"skipped",capture_item_at_time:"skipped",auto_stop:"skipped",attempted:"skipped",items:g,time_remain:"skipped",mark_record:"skipped",variable_name:this.model.get("variableName")};
};a.prototype.onClose=function(){return clearInterval(this.interval);};a.prototype.getSum=function(){var f,e,g,d,c;f={correct:0,incorrect:0,missing:this.items.length-this.lastAttempted,total:this.items.length};
c=this.gridOutput;for(g=0,d=c.length;g<d;g++){e=c[g];if(e==="correct"){f.correct+=1;}if(e==="incorrect"){f.incorrect+=1;}}return{correct:f.correct,incorrect:f.incorrect,missing:f.missing,total:f.total,correct_per_minute:f.correct*(60/this.timeElapsed)};
};return a;})(Backbone.View);