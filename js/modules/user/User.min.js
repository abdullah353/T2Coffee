var User,_ref,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];}}function c(){this.constructor=d;}c.prototype=b.prototype;
d.prototype=new c();d.__super__=b.prototype;return d;},__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b;
}}return -1;};User=(function(a){__extends(b,a);function b(){_ref=b.__super__.constructor.apply(this,arguments);return _ref;}b.prototype.url="user";b.prototype["default"]={name:null,roles:[],groups:["default"]};
b.prototype.initialize=function(c){this.name=this["default"].name;this.roles=this["default"].roles;this.messages=[];return this.temp={};};b.prototype.signup=function(c,d){var e=this;
return $.couch.signup({name:c},d,{success:function(g,f,h){if(e.temp.intent==="login"){e.temp.intent="retry_login";e.login(e.temp.name,e.temp.pass);}else{e.addMessage("New user "+temp.name+" created. Welcome to Tangerine.");
}e.unset("messages");return e.save();},error:function(f,g,h){if((e.temp.intent!=null)&&e.temp.intent==="login"){return e.showMessage("Password incorrect, please try again.");
}else{return e.showMessage("Error username "+e.temp.name+" already taken. Please try another name.");}}});};b.prototype.login=function(c,d){var e=this;
this.temp={name:c,pass:d};return $.couch.login({name:this.temp.name,password:this.temp.pass,success:function(f){e.name=e.temp.name;e.roles=f.roles;return e.fetch({success:function(g){e.clearAttempt();
return e.trigger("change:authentication");}});},error:function(f,g,h){e.name=e["default"].name;e.roles=e["default"].roles;if((e.temp.intent!=null)&&e.temp.intent==="retry_login"){return e.addMessage(h);
}else{e.temp.intent="login";return e.signup(e.temp.name,e.temp.pass);}}});};b.prototype.verify=function(c){if(this.name===null){if((c!=null?c.isUnregistered:void 0)!=null){return c.isUnregistered();
}else{return Tangerine.router.navigate("login",true);}}else{if(c!=null){if(typeof c.isRegistered==="function"){c.isRegistered();}}if(this.isAdmin()){return c!=null?typeof c.isAdmin==="function"?c.isAdmin():void 0:void 0;
}else{return c!=null?typeof c.isUser==="function"?c.isUser():void 0:void 0;}}};b.prototype.fetch=function(c){var d=this;if(c==null){c={};}return $.couch.session({success:function(h){var i,g,f,e;
if(h.userCtx.name!==null){d.id="tangerine.user:"+h.userCtx.name;d.name=h.userCtx.name;d.roles=[];e=h.userCtx.roles;for(g=0,f=e.length;g<f;g++){i=e[g];if(!~i.indexOf("group.")){d.roles.push(i);
}}return b.__super__.fetch.call(d,{success:function(k,j,l){return typeof c.success==="function"?c.success():void 0;},error:function(k,j,l){d.unset("messages");
d.save({_id:d.id,groups:[]},{wait:true});return b.__super__.fetch.call(d,{success:function(){return typeof c.success==="function"?c.success():void 0;},error:function(){return location.reload();
}});}});}else{if(typeof c.success==="function"){c.success();}return d.logout();}},error:function(e,f,g){this.trigger("change:authentication");throw""+e+" Session Error\n"+f+"\n"+g;
}});};b.prototype.isAdmin=function(){return __indexOf.call(this.roles,"_admin")>=0;};b.prototype.logout=function(){var c=this;return $.couch.logout({success:function(){$.cookie("AuthSession",null);
c.name=c["default"].name;c.roles=c["default"].roles;c.clear();c.trigger("change:authentication");return Tangerine.router.navigate("login",true);}});};b.prototype.clearAttempt=function(){return this.temp=this["default"].temp;
};b.prototype.joinGroup=function(d){var c;c=this.get("groups");if(!~c.indexOf(d)){c.push(d);this.unset("messages");return this.save({groups:c});}};b.prototype.leaveGroup=function(d){var c;
c=this.get("groups");if(~c.indexOf(d)){c=_.without(c,d);return this.save({groups:c});}};b.prototype.addMessage=function(c){return this.set("messages",this.get("messages").push(c));
};b.prototype.showMessage=function(c){return this.set("messages",[c]);};b.prototype.clearMessages=function(c){return this.set("messages",[]);};return b;
})(Backbone.Model);