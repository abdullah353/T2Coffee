var StudentToDateView,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments);};},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a];
}}function c(){this.constructor=d;}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d;};StudentToDateView=(function(b){__extends(a,b);
function a(){this.afterRender=__bind(this.afterRender,this);_ref=a.__super__.constructor.apply(this,arguments);return _ref;}a.prototype.events={"click .xtick":"changeCurrentIndex"};
a.prototype.changeCurrentIndex=function(d){var c;c=$(d.target);this.currentIndex=parseInt(c.attr("data-index"));this.processResults();this.readyFlot();
return this.afterRender();};a.prototype.bucketize=function(f){var g,c,e,d;c=[];for(e=0,d=f.length;e<d;e++){g=f[e];c[g]=[];}return c;};a.prototype.initialize=function(l){var q,p,r,m,d,n,o,h,g,f,e,u,x,w,v,s,c,k;
r=604800000;this.currentPart=Math.round(((new Date()).getTime()-l.klass.get("startDate"))/r);if(this.currentIndex==null){this.currentIndex=this.currentPart;
}this.range=(function(){var y,i,j;j=[];for(q=y=1,i=this.currentPart;1<=i?y<=i:y>=i;q=1<=i?++y:--y){j.push(q);}return j;}).call(this);o=[];k=l.subtests;
for(h=0,u=k.length;h<u;h++){m=k[h];d=m.get("part");if(o[d]!=null){o[d].push(m);}else{o[d]=[m];}}this.subtestsByResultsBucket=[];this.resultsByBucketByPart={};
for(q=g=0,x=o.length;g<x;q=++g){n=o[q];if(n===void 0){continue;}for(f=0,w=n.length;f<w;f++){m=n[f];if(this.resultsByBucketByPart[m.get("resultBucket")]===void 0){this.resultsByBucketByPart[m.get("resultBucket")]=[];
this.subtestsByResultsBucket[m.get("resultBucket")]=[];}this.resultsByBucketByPart[m.get("resultBucket")][q]=l.results.where({subtestId:m.id,klassId:l.klass.id,studentId:l.studentId});
this.subtestsByResultsBucket[m.get("resultBucket")].push(m);}}this.bucketList=_.keys(this.resultsByBucketByPart);this.resultsByPart=[];for(q=e=0,v=o.length;
e<v;q=++e){n=o[q];if(n==null){continue;}for(p=c=0,s=n.length;c<s;p=++c){m=n[p];if(this.resultsByPart[q]!=null){this.resultsByPart[q]=this.resultsByPart[q].concat(l.results.where({subtestId:m.id}));
}else{this.resultsByPart[q]=l.results.where({subtestId:m.id});}}}this.processResults();return this.readyFlot();};a.prototype.processResults=function(){var e,d,j,f,c,l,i,h,k,g;
this.percentagesByStudent=[];this.flotArrays=this.bucketize(this.bucketList);g=this.resultsByBucketByPart;for(j in g){d=g[j];for(f in d){i=d[f];c=[];for(h=0,k=i.length;
h<k;h++){l=i[h];e=this.getBasicStats(l);c.push(e.percentCorrect);}if(i.length>0){this.flotArrays[j].push([parseInt(f),Math.ave.apply(this,c)]);if(parseInt(f)===this.currentIndex){this.percentagesByStudent[j]=c;
}}}}console.log(this.percentagesByStudent);return this.warnings=Tangerine.ReportWarnings.StudentToDateView({percentages:this.percentagesByStudent,studentName:this.options.student.get("name")});
};a.prototype.readyFlot=function(){var d,m,c,n,j,k,e,h,g,f,l=this;c=this.bucketize(this.bucketList);h=this.subtestsByResultsBucket;for(m in h){e=h[m];if(((g=e[0])!=null?typeof g.get==="function"?g.get("timer"):void 0:void 0)>0&&_.flatten(this.resultsByBucketByPart[e[0].get("resultBucket")]).length>1){c[m]="lines";
}else{c[m]="points";}}this.flotData=[];f=this.flotArrays;for(d in f){n=f[d];n=_.reject(n,function(i){return i[0]>l.currentPart;});if(c[d]==="lines"){n.push([this.currentPart+1,_.last(n)[1]]);
}k={label:d,data:n};k[c[d]]={show:true,radius:4,width:4};this.flotData.push(k);}return this.flotOptions={yaxis:{min:0,max:100,ticks:10},xaxis:{min:0.5,max:this.currentPart+0.5,ticks:(function(){var o,p,i;
i=[];for(j=o=1,p=this.currentPart;1<=p?o<=p:o>=p;j=1<=p?++o:--o){i.push(String(j));}return i;}).call(this),tickDecimals:0,tickFormatter:function(i){return"<button class='command xtick' data-index='"+i+"'>"+i+"</button>";
}},grid:{markings:[{color:"#ffc",xaxis:{to:this.currentIndex+0.5,from:this.currentIndex-0.5}}]}};};a.prototype.getBasicStats=function(d){var g,h,f,j,i,e,c;
g=0;j=0;c=d.get("subtestData").items;for(i=0,e=c.length;i<e;i++){h=c[i];if(h.itemResult==="correct"){g++;}j++;}f=(g/j)*100;return{percentCorrect:f,correctItems:g,totalItems:j,studentId:d.get("studentId")};
};a.prototype.render=function(){var c;this.$el.html("      <h1>"+(t("student progress report"))+"</h1>      <h2>"+(this.options.student.get("name"))+"</h2>      <div id='chart' style='width:450px; height:300px;'></div>      <div id='warnings'></div>    ");
this.trigger("rendered");return c="#BDDC93";};a.prototype.afterRender=function(){var e,g,f,d,c;g="";if(this.warnings.length>0){g="<div class='warnings'>        <b>Warning</b><br>";
c=this.warnings;for(f=0,d=c.length;f<d;f++){e=c[f];g+=e.html;}g+="</div>";this.$el.find("#warnings").html(g);}else{this.$el.find("#warnings").html("");
}this.flotOptions.legend={show:true};return this.plot=$.plot(this.$el.find("#chart"),this.flotData,this.flotOptions);};return a;})(Backbone.View);